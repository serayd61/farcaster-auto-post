name: AI-Powered Farcaster Posts (Advanced)

on:
  pull_request:
    types: [opened, closed, synchronize]
  release:
    types: [published, created]
  issues:
    types: [opened, labeled]
  push:
    branches:
      - main
      - master
  schedule:
    # HaftalÄ±k Ã¶zet - Her Pazartesi 10:00
    - cron: '0 10 * * 1'
  workflow_dispatch:
    inputs:
      custom_message:
        description: 'Custom message to enhance with AI'
        required: false
        type: string
      post_type:
        description: 'Type of post'
        required: false
        type: choice
        options:
          - announcement
          - update
          - question
          - celebration
        default: 'announcement'

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: read
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Son 50 commit'i al

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm init -y
          npm install @standard-crypto/farcaster-js

      - name: Generate AI Content
        id: ai_content
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
          AI_MODEL: ${{ vars.AI_MODEL || 'gpt-4o-mini' }}
          MAX_TOKENS: ${{ vars.MAX_TOKENS || '280' }}
          AI_TEMPERATURE: ${{ vars.AI_TEMPERATURE || '0.7' }}
          CUSTOM_MESSAGE: ${{ inputs.custom_message }}
          POST_TYPE: ${{ inputs.post_type }}
          # Ã–zel prompt'lar (Repository Variables olarak ayarlanabilir)
          PR_OPENED_SYSTEM_PROMPT: ${{ vars.PR_OPENED_SYSTEM_PROMPT }}
          PR_OPENED_USER_PROMPT: ${{ vars.PR_OPENED_USER_PROMPT }}
          PR_MERGED_SYSTEM_PROMPT: ${{ vars.PR_MERGED_SYSTEM_PROMPT }}
          PR_MERGED_USER_PROMPT: ${{ vars.PR_MERGED_USER_PROMPT }}
          RELEASE_SYSTEM_PROMPT: ${{ vars.RELEASE_SYSTEM_PROMPT }}
          RELEASE_USER_PROMPT: ${{ vars.RELEASE_USER_PROMPT }}
          ISSUE_SYSTEM_PROMPT: ${{ vars.ISSUE_SYSTEM_PROMPT }}
          ISSUE_USER_PROMPT: ${{ vars.ISSUE_USER_PROMPT }}
          WEEKLY_SYSTEM_PROMPT: ${{ vars.WEEKLY_SYSTEM_PROMPT }}
          WEEKLY_USER_PROMPT: ${{ vars.WEEKLY_USER_PROMPT }}
        run: |
          cat > generate_content.js << 'EOFJS'
          const https = require('https');
          const { execSync } = require('child_process');
          const fs = require('fs');

          class ContentGenerator {
            constructor() {
              this.openaiKey = process.env.OPENAI_API_KEY;
              this.context = JSON.parse(process.env.GITHUB_CONTEXT);
              this.model = process.env.AI_MODEL || 'gpt-4o-mini';
              this.maxTokens = parseInt(process.env.MAX_TOKENS || '280');
              this.temperature = parseFloat(process.env.AI_TEMPERATURE || '0.7');
            }

            async callOpenAI(messages) {
              return new Promise((resolve, reject) => {
                const data = JSON.stringify({
                  model: this.model,
                  messages: messages,
                  max_tokens: this.maxTokens,
                  temperature: this.temperature
                });

                const options = {
                  hostname: 'api.openai.com',
                  path: '/v1/chat/completions',
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.openaiKey}`,
                    'Content-Length': data.length
                  }
                };

                const req = https.request(options, (res) => {
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    if (res.statusCode === 200) {
                      const response = JSON.parse(body);
                      resolve(response.choices[0].message.content.trim());
                    } else {
                      reject(new Error(`OpenAI error: ${res.statusCode} - ${body}`));
                    }
                  });
                });

                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }

            async generate() {
              const { event_name, event } = this.context;
              let content = null;

              // Manuel custom message varsa
              if (process.env.CUSTOM_MESSAGE) {
                const postType = process.env.POST_TYPE || 'announcement';
                const prompts = {
                  announcement: 'Bu mesajÄ± heyecan verici bir duyuru formatÄ±nda yeniden yaz',
                  update: 'Bu mesajÄ± bilgilendirici bir gÃ¼ncelleme formatÄ±nda yeniden yaz',
                  question: 'Bu mesajÄ± topluluktan geri bildirim isteyen bir soru formatÄ±na Ã§evir',
                  celebration: 'Bu mesajÄ± kutlama havasÄ±nda, coÅŸkulu bir formata Ã§evir'
                };

                content = await this.callOpenAI([
                  {
                    role: "system",
                    content: "Sen yaratÄ±cÄ± bir sosyal medya yÃ¶neticisisin."
                  },
                  {
                    role: "user",
                    content: `${prompts[postType]}: "${process.env.CUSTOM_MESSAGE}". Max 280 karakter, emoji kullan.`
                  }
                ]);
              }
              // PR aÃ§Ä±ldÄ±
              else if (event_name === 'pull_request' && event.action === 'opened') {
                const pr = event.pull_request;
                const systemPrompt = process.env.PR_OPENED_SYSTEM_PROMPT || 
                  "Sen bir sosyal medya uzmanÄ±sÄ±n. GitHub PR'larÄ±nÄ± ilgi Ã§ekici mesajlara dÃ¶nÃ¼ÅŸtÃ¼rÃ¼yorsun.";
                
                const userPrompt = process.env.PR_OPENED_USER_PROMPT || 
                  `Yeni PR: "${pr.title}"\nAÃ§Ä±klama: "${pr.body || 'Yok'}"\nYazar: @${pr.user.login}\n\nFarcaster iÃ§in kÄ±sa (280 karakter), ilgi Ã§ekici mesaj yaz.`;

                content = await this.callOpenAI([
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userPrompt }
                ]);
              }
              // PR merge edildi
              else if (event_name === 'pull_request' && event.action === 'closed' && event.pull_request.merged) {
                const pr = event.pull_request;
                const systemPrompt = process.env.PR_MERGED_SYSTEM_PROMPT || 
                  "Sen coÅŸkulu bir sosyal medya yÃ¶neticisisin.";
                
                const userPrompt = process.env.PR_MERGED_USER_PROMPT || 
                  `PR merge edildi! "${pr.title}" by @${pr.user.login}\n+${pr.additions} -${pr.deletions}\n\nKutlama mesajÄ± yaz (280 karakter).`;

                content = await this.callOpenAI([
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userPrompt }
                ]);
              }
              // Release
              else if (event_name === 'release') {
                const release = event.release;
                const systemPrompt = process.env.RELEASE_SYSTEM_PROMPT || 
                  "Sen bir Ã¼rÃ¼n pazarlamacÄ±sÄ±sÄ±n.";
                
                const userPrompt = process.env.RELEASE_USER_PROMPT || 
                  `Yeni release: ${release.tag_name}\n"${release.body || 'Yok'}"\n\nHeyecan verici duyuru (280 karakter).`;

                content = await this.callOpenAI([
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userPrompt }
                ]);
              }
              // Issue aÃ§Ä±ldÄ±
              else if (event_name === 'issues' && event.action === 'opened') {
                const issue = event.issue;
                
                // EÄŸer "announcement" label'Ä± varsa paylaÅŸ
                const hasAnnouncement = issue.labels.some(l => 
                  ['announcement', 'duyuru', 'public'].includes(l.name.toLowerCase())
                );
                
                if (hasAnnouncement) {
                  const systemPrompt = process.env.ISSUE_SYSTEM_PROMPT || 
                    "Sen topluluk yÃ¶neticisisin.";
                  
                  const userPrompt = process.env.ISSUE_USER_PROMPT || 
                    `Issue: "${issue.title}"\n"${issue.body || 'Yok'}"\n\nTopluluk iÃ§in mesaj (280 karakter).`;

                  content = await this.callOpenAI([
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                  ]);
                }
              }
              // Push to main
              else if (event_name === 'push' && ['main', 'master'].includes(event.ref.split('/').pop())) {
                // Sadece Ã¶nemli commit'leri paylaÅŸ
                const commits = event.commits || [];
                const importantCommits = commits.filter(c => 
                  !c.message.toLowerCase().includes('merge') &&
                  !c.message.toLowerCase().startsWith('update') &&
                  commits.indexOf(c) === commits.length - 1 // Son commit
                );

                if (importantCommits.length > 0) {
                  const commit = importantCommits[0];
                  content = await this.callOpenAI([
                    {
                      role: "system",
                      content: "Sen bir sosyal medya uzmanÄ±sÄ±n."
                    },
                    {
                      role: "user",
                      content: `Git commit mesajÄ±: "${commit.message}"\n\nBu deÄŸiÅŸikliÄŸi Farcaster'da duyurmak iÃ§in kÄ±sa mesaj (280 karakter).`
                    }
                  ]);
                }
              }
              // HaftalÄ±k Ã¶zet
              else if (event_name === 'schedule') {
                let commits = '';
                try {
                  commits = execSync(
                    'git log --since="7 days ago" --pretty=format:"%h - %s" --no-merges | head -20',
                    { encoding: 'utf-8' }
                  );
                } catch (error) {
                  commits = 'Commit bilgisi alÄ±namadÄ±';
                }

                const systemPrompt = process.env.WEEKLY_SYSTEM_PROMPT || 
                  "Sen bir topluluk liderisin.";
                
                const userPrompt = process.env.WEEKLY_USER_PROMPT || 
                  `Bu hafta:\n${commits}\n\nHaftalÄ±k Ã¶zet (280 karakter, pozitif).`;

                content = await this.callOpenAI([
                  { role: "system", content: systemPrompt },
                  { role: "user", content: userPrompt }
                ]);
              }

              if (content) {
                console.log(`âœ… Generated:\n${content}`);
                const escaped = content
                  .replace(/%/g, '%25')
                  .replace(/\n/g, '%0A')
                  .replace(/\r/g, '%0D');
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `content=${escaped}\n`);
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `success=true\n`);
              } else {
                console.log('â„¹ï¸ No content for this event');
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `success=false\n`);
              }

              return content;
            }
          }

          const generator = new ContentGenerator();
          generator.generate()
            .then(() => process.exit(0))
            .catch(error => {
              console.error('âŒ Error:', error.message);
              process.exit(1);
            });
          EOFJS

          node generate_content.js

      - name: Post to Farcaster
        if: steps.ai_content.outputs.success == 'true'
        env:
          FARCASTER_FID: ${{ secrets.FARCASTER_FID }}
          FARCASTER_MNEMONIC: ${{ secrets.FARCASTER_MNEMONIC }}
          AI_CONTENT: ${{ steps.ai_content.outputs.content }}
        run: |
          npx @standard-crypto/farcaster-js cast "$AI_CONTENT"

      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸ¤– AI-Powered Farcaster Post" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.ai_content.outputs.success }}" == "true" ]; then
            echo "### âœ… Successfully Posted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Content:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.ai_content.outputs.content }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Content Generated" >> $GITHUB_STEP_SUMMARY
            echo "This event type didn't trigger content generation." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        run: |
          echo "::error::Failed to generate or post content. Check OpenAI API key and Farcaster credentials."
